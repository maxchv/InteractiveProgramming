# Неделя 4 -  Событий-ориентированное программирование: работа с мышью и клавиатурой

Изучаются базовые концепции событий-ориентированного программирования, создание простых интерактивных программ

## Атрибуты игрового объекта (GameObject)

Игровой объект или [GameObject](https://photonstorm.github.io/phaser3-docs/Phaser.GameObjects.GameObject.html),который создается в функции `create()` игровой сцены (например, при вызове функции `this.add.sprite()`) имеет ряд атрибутов и методов.

Рассмотрим некоторые полезные атрибуты:

* `x` - координата по оси `x` для игрового объекта (number);
* `y` - координата по оси `y` для игрового объекта (number);
* `scale` - масштаб для игрового объекта (number);
* `scaleX` - масштаб игрового объекта по оси `X` (number);
* `scaleY` - масштаб игрового объекта по оси `Y` (number);
* `visible` - видимость игрового объекта (boolean);
* `originX` - относительное начало координат для оси `x` игрового объекта (number);
* `originY` - относительное начало координат для оси `y` игрового объекта (number);
* `width` - ширина игрового объекта (number);
* `height` - высота игрового объекта (number);
* `flipX` - зеркальное отражение относительно оси `x` (number);
* `flipY` - зеркальное отражение относительно оси `y` (number);
* `angle` - угол поворота игрового объекта в градусах по часовой стрелке (number);

## Взаимодействие с игроком. Событий-ориентированное программирование

Настало время сделать так, что бы в нашу игру можно было играть!

`Phaser` дает нам возможность обрабатывать события связанные с компьютерной мышью и клавиатурой, таким образом нам
необходимо обрабатывать эти события.

Давайте сейчас рассмотрим способы обработки событий связанных с компьютерной мышью.

Для того, что бы иметь возможность взаимодействовать с игровым объектом (`GameObject`), нам необходимо вызвать метод `setInteractive()` для него.

Метод `setInteractive()` указывает `Phaser` прослушивать события связанные с этим игровым объектом (`GameObject`).

После вызова метода `setInteractive()` мы можем предоставить игровому объекту (`GameObject`) обработчик события.

Обработчик события - это функция, которая вызывается, когда указанное взаимодействие (событие) происходит для заданного игрового объекта (`GameObject`).

Рассмотрим четыре события связанных с компьютерной мышью:

* `'pointerdown'`: это событие наступает в тот момент, когда кнопка компьютерной мыши была нажата (но еще не отпущена) для игрового объекта (`GameObject`).
* `'pointerup'`: это событие наступает после события `'pointerdown'` в момент, когда кнопка компьютерной мыши была отпущена.
* `'pointerover'`: это событие наступает тогда, когда указатель компьютерной мыши находится над игровым объектом (`GameObject`).
* `'pointerout'`: это событие наступает тогда, когда указатель компьютерной мыши выходит за границы игрового объекта (`GameObject`).

Интересным является тот факт, что события `'pointerdown'` и `'pointerup'` - разные.

Теперь давайте поменяем цвет круга при клике мышкой по нему.

Мы будем использовать событие `'pointerup'` потому, что это будет означать, что мы кликнули мышкой и только что отпустили кнопку.
Мы добавим слушателя на событие `'pointerup'` что бы изменить цвет круга.

Пример:

```JavaScript
let circle;

function callback() {
    this.fillColor = 0x00FF00;
}

function create() {
  circle = this.add.circle(50, 50, 20, 0xFF0000);
  
  circle.setInteractive();
  
  circle.on('pointerup', callback);
}

const config = {
    scene: {
        create
    }
}

const game = new Phaser.Game(config)
```

В приведенном выше примере создается красный круг в методе `create()`, затем через метод `setInteractive()` он становится интерактивным.
Так как интерактивный игровой объект позволяет взаимодействие с ним мы добавляем слушателя события `'pointerup'`.
Для этого вызываем метод `on()` для игрового объекта (`GameObject`).

Метод `on()` принимает два агрумента: имя события (`'pointerup'`) и функцию обратного вызова (слушателя).
Мы создали новую функцию `callback()` имя которой передали в качестве второго аргумента в функцию `on()`.
Внутри функции `callback()` мы изменили цвет круга `this.fillColor`.

Обратите внимание, что в функции `this` ссылается на наш круг, таим обозом не нужно обращаться к глобальной переменной `circle`.

Изменение значения переменной `this.fillColor` позволяет задать цвет для круга (то, что нам нужно).

Заметим, что мы изменили состояние игрового объекта без объявления функции `update()`.
Слушатели на события могут быть подписаны в функции `create()`, потому, что они являются частью определения игрового объекта (`GameObject`) и настроек игры.

## События клавиатуры

Не многие игры используют исключительно компьютерную мышь.
Большинство браузерных игр, особенно со сложным геймплеем, также используют и клавиатуры.

До этого момента мы назначали мышиные события только для конкретного игрового объекта (`GameObjects`).
Это позволяло нам понимать находится ли курсор мышки над игровым объектом или он был кликнут в нашей игре.

Когда игрок кликнет мышью в заданной точке игровой сцены мы можем получить координаты `x` и `у`.
Клавиатура предоставляет другой интерфейс.
Обработчик события связанные с клавиатурой должен будет обрабатывать нажатия любых клавиш в нашей игре, таким образом подписываться на события мы должны не для конкретного игрового объекта (`GameObjects`), а для игры в целом.

Первый способ добавить обработчик события нажатия клавиш на клавиатуре - это вызвать метод `this.input.keyboard.on()` внутри функции `create()`.

Этот метод принимает два аргумента: первый - название события, например `"keydown-A"` для клавиши `A`.
Второй аргумент - функция, которая будет вызвана при нажатии клавиши.

Пример:

```JavaScript

function keyboardHandler() {
    circle.fillColor = 0xFFFF00;
}

function create() {
  gameState.circle = this.add.circle(30, 30, 10, 0xFF0000);
  this.input.keyboard.on('keydown-W', keyboardHandler);
}
```

Примеры событий связанных с клавиатурой:

* `keydown-A` - событие нажатие кнопки на клавиатуре A;
* `keydown` - событие нажатие кнопки любой кнопки на клавиатуре;
* `keyup-A` - событие на клавиатуре при отпускании клавиши A.
* `keyup` - событие при отпускании любой клавиши на клавиатуре клавиши.

Приведенный выше код позволяет создать круг красного цвета и при нажатии кнопки `W` на клавиатуре позволяет изменить цвет на желтый.

## Объект курсор (cursor)

Другой способ обработать события связанные с клавиатурой предоставляет метод `createCursorKeys()`.
Этот метод создает объект в котором есть возможность получить доступ к наиболее часто используемым клавишам (UP, DOWN, LEFT, RIGHT, SHIFT, и SPACE).
Мы можем сохранить этот объект в глобальной переменной `cursor` для того, чтобы проверять в методе `update()` какая была нажата клавиша.

```JavaScript
let cursor; // объект курсор
let circle;

function create() {
  circle = this.add.circle(50, 50, 20, 0xFF0000);
  cursors = this.input.keyboard.createCursorKeys(); // создаем объект-курсор
}

function update() {
  if (cursors.left.isDown) {
    // перемещаем круг влево
    circle.x -= 3;
  }
}

const config = {
  scene: {
    create,
    update
  }
};

const game = new Phaser.Game(config);
```

В примере выше мы создали переменную `cursors` для сохранения объекта, возвращаемого методом `.createCursorKeys()` из `this.input.keyboard` внутри функции `create()`.

В функции `update()` теперь делаем проверку нажата ли кнопка на клавиатуре **стрелка влево**: `cursors.left.isDown`.
В случае, если кнопка **стрелка влево** нажата, то перемещаем круг налево на 3 пикселя.

## Циклы

Циклы позволяют многократно повторить часть кода. Это удобно когда нужно, например, создать 64 игровых объекта и не хочеться применять технику известную как Copy-Paste

В `JavaScript` существует три типа циклов:

1. Цикл со счетчиком `for`
2. Цикл со предусловием `while`
3. Цикл со постусловием `do..while`

Давайте посмотрим на один из наиболее популярный цикл `for`.

Предположим, что нам необходимо повторить некий код несколько раз.
И мы заранее знаем необходимое количество повторений.
В этом случае как раз кстати нам подойдет цикл `for`:

```JavaScript
for (let i = 0; i < 10; i++) {
  console.log(i);
}
```

При выполнении приведенного выше кода в консоли отобразятся цифро от 0 до 9 (10 цифр!).

В отличии от цикла со счетчиком, в цикле с предусловием `while` задается только условие прекращения цикла.

```JavaScript
let i = 0;
while(i < 10) {
  console.log(i);
  i++;
}
```

В цикле с постусловием `do..while` условие проверяется не перед циклом, а после:

```JavaScript
let i = 0;
do {
  console.log(i);
  i++;
} while(i < 10);
```

Этот цикл удобен в тех случаях, когда необходимо хотя бы один раз выполнить цикл.

При работе с циклами может возникнуть ситуация, что необходимо выйти из цикла или перейти на следующую итерацию.

Для этого существуют инструкции `break` и `continue`.

Оператор `break` немедленно прекращает выполнение цикла.

```JavaScript
for(let i = 0; i < 10; i++) {
  if(i == 3) {
    break;
  }
  
  console.log(i);
}
```

В приведенном выше примере цикл `for` выполнится только четыре раза и в консоль выведутся цифры 0 1 и 2.
На четвертой итерации выполнится условие `if(i == 3)` и сработает оператор безусловного завершения цикла `break` в результате чего цикл преждевременно завершит свою работу.

Оператор `break` часто используют для завершения работы так называемого бесконечного цикла:

```JavaScript
let i = 0;
while(true) {
  if(i >= 9) {
    break;
  }
  console.log(i);
}
```

Для перехода к следующей итерации (к следующему повторению) цикла используется оператор `continue`.

В следующем примере будут напечатаны только четные цифры в диапазоне от 0 до 9

```JavaScript
for(let i = 0; i<10; i++) {
  if(i % 2 == 1) {
    continue;
  }
  
  console.log(i);
}
```

При использовании циклов важно задавать правильные условия, иначе цикл может стать бесконечным
и программа зациклится.

К примеру, этот цикл будет бесконечным:

```JavaScript
for(let i=0; i<100; i--) {
  console.log(i);
}
```

Также возможен случай для циклов `for` и `while`, когда цикл не выполниться ни разу:

```JavaScript
let i = 10;
while(i < 10) {
  console.log(i);
  i--;
}
```

## Вопросы

1. Как сделать так, что бы иметь возможность взаимодействовать с игровым объектом?
2. Какое событие наступает в тот момент, когда кнопка компьютерной мыши была нажата (но еще не отпущена) для игрового объекта (`GameObject`)?
3. Какое событие наступает после события `'pointerdown'` в момент, когда кнопка компьютерной мыши была отпущена?
4. Какое событие наступает тогда, когода указатель компьютерной мыши находится над игровым объектом (`GameObject`)?
5. Какое событие наступает тогда, когода указатель компьютерной мыши выходит за границы игрового объекта (`GameObject`)?
6. Какой метод позволяет добавить обработчик события к игровому объекту?
7. Какие способы существуют в `Phaser` для добавления обработчика события связанного с клавиатурой?
8. Как называется событие связанное с нажатием кнопки `A` на клавиатуре?
9. Назовите основные атрибуты игрового объекта

video: https://youtu.be/7mE8AEN91iE

## Домашнее задание:

1. Создать проект игры на phaser (включая базовую структуру файлов и папок)
2. Добавить игровой персонаж на сцену (можно нарисовать самому)
3. Реализовать перемещение игровым персонажем по сцене при помощи кнопок вверх, вниз, влево и вправо на клавиатуре (можно также использовать кнопки WASD)

## Ссылки

* [Scene](https://photonstorm.github.io/phaser3-docs/Phaser.Scene.html)
* [InputPlugin](https://photonstorm.github.io/phaser3-docs/Phaser.Input.InputPlugin.html)